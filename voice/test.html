<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <script src="node_modules/@picovoice/picovoice-web-en-worker/dist/iife/index.js"></script>
    <script src="node_modules/@picovoice/web-voice-processor/dist/iife/index.js"></script>
    <script type="application/javascript">
        class VoiceRecognition {
            constructor() {

            }
            async startPorcupine() {
                const porcupineWorker = await PorcupineWorkerFactory.create(
                    [{ builtin: "Alexa", sensitivity: 0.65 }]
                );
                porcupineWorker.onmessage = (msg) => {
                    switch (msg.data.command) {
                        case 'ppn-keyword':
                            // Porcupine keyword detection
                            console.log("Porcupine detected " + msg.data.keywordLabel);
                            this.stopPorcupine()
                            // 开始执行语音识别
                            if (!this.recognition) {
                                this.initRecognition()
                            }
                            this.recognition.start()
                            break;
                        default:
                            break;
                    }
                };
                const webVp = await WebVoiceProcessor.init({
                    engines: [porcupineWorker],
                    start: true,
                });
                this.webVp = webVp
                this.porcupineWorker = porcupineWorker
            }

            stopPorcupine() {
                this.webVp.release()
                this.porcupineWorker.sendMessage({ command: "release" })
            }

            // 初始化语音识别
            initRecognition() {
                let listenText = '';
                let recognition = new webkitSpeechRecognition();
                recognition.lang = 'cmn-Hans-CN';
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onstart = function () {
                    listenText = ''
                    console.log('开始')
                }

                recognition.onerror = function (event) {
                    console.log('错误')
                };

                recognition.onend = function () {
                    console.log("识别结束，发送命令中...")
                }

                recognition.onresult = (event) => {
                    const result = event.results;
                    if (typeof (result) == 'undefined') {
                        console.log("gg---");
                        return;
                    }
                    let final_transcript = '';
                    for (let i = event.resultIndex; i < result.length; ++i) {
                        const transcript = result[i][0].transcript;
                        if (result[i].isFinal) {
                            final_transcript += transcript
                        } else {
                            listenText += transcript;
                        }
                    }
                    // 一句话识别完毕
                    if (final_transcript != "") {
                        console.log(final_transcript)
                        recognition.stop();
                        return;
                    }
                    // this.$('.speech-text').textContent = listenText
                }
                this.recognition = recognition
            }
        }
    </script>
</head>

<body>
    <script>
        const vf = new VoiceRecognition()
        vf.startPorcupine()
    </script>
</body>

</html>