<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <script src="node_modules/@picovoice/porcupine-web-en-worker/dist/iife/index.js"></script>
    <script src="node_modules/@picovoice/web-voice-processor/dist/iife/index.js"></script>
    <script type="application/javascript">
        class VoiceRecognition {
            constructor() {

            }
            async startPorcupine() {
                console.log('加载中，请等待...')
                const porcupineWorker = await PorcupineWebEnWorker.PorcupineWorkerFactory.create(
                    [{ builtin: "Jarvis", sensitivity: 0.65 }]
                );
                porcupineWorker.onmessage = (msg) => {
                    console.log(msg)
                    switch (msg.data.command) {
                        case 'ppn-keyword':
                            // Porcupine keyword detection
                            console.log("Porcupine detected " + msg.data.keywordLabel);
                            this.stopPorcupine()
                            // 开始执行语音识别
                            if (!this.recognition) {
                                this.initRecognition()
                            }
                            this.recognition.start()
                            break;
                        default:
                            break;
                    }
                };
                try {
                    const webVp = await WebVoiceProcessor.WebVoiceProcessor.init({
                        engines: [porcupineWorker]
                    });
                    this.webVp = webVp
                    this.porcupineWorker = porcupineWorker
                    setTimeout(() => {
                        console.log('初始化完成')
                    }, 1000)
                } catch (ex) {
                    console.error(ex)
                }
            }

            stopPorcupine() {
                this.webVp.release()
                this.porcupineWorker.postMessage({ command: "release" })
            }

            // 初始化语音识别
            initRecognition() {
                let listenText = '';
                let recognition = new webkitSpeechRecognition();
                recognition.lang = 'cmn-Hans-CN';
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onstart = function () {
                    console.log('开始')
                }

                recognition.onerror = function (event) {
                    console.log('错误')
                };

                recognition.onend = function () {
                    console.log("识别结束，发送命令中...")
                    window.VOICE_RECOGNITION.startPorcupine()
                }

                recognition.onresult = (event) => {
                    const result = event.results;
                    if (typeof (result) == 'undefined') {
                        console.log("gg---");
                        return;
                    }
                    let listenText = ''
                    let final_transcript = '';
                    for (let i = event.resultIndex; i < result.length; ++i) {
                        const transcript = result[i][0].transcript;
                        if (result[i].isFinal) {
                            final_transcript += transcript
                        } else {
                            listenText += transcript;
                        }
                    }
                    // 一句话识别完毕
                    if (final_transcript != "") {
                        console.log(final_transcript)
                        recognition.stop();
                        return;
                    }
                    console.log(listenText)
                    // this.$('.speech-text').textContent = listenText
                }
                this.recognition = recognition
            }
        }


        document.addEventListener("DOMContentLoaded", function () {

            const vf = new VoiceRecognition()
            vf.startPorcupine()
            window.VOICE_RECOGNITION = vf

        });
    </script>
</head>

<body>
</body>

</html>